---
title: "Regresiones"
author: "Karina Bartolom칠"
date: '2022-05-01'
output: 
  github_document:
    pandoc_args: "--webtex"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      message = FALSE)

library(texPreview)
tex_opts$set(
  density = 600  # High resolution LaTeX output
)

# Include HTML images when knitting with github_document
if (isTRUE(getOption('knitr.in.progress'))) {
  tex_opts$set(
    returnType = "html"
  )
}

# This could go in tex_opts$set, but it doesn't seem to actually get used there
usrPackages <- "\\renewcommand*\\familydefault{\\rmdefault}"
```



# Referencias

<https://bookdown.org/roback/bookdown-BeyondMLR/ch-MLRreview.html>

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(gt)
library(AER)
library(performance)
```

Se utiliza el paquete `{AER}` 游닍 (Applied Econometric with R), que contiene un gran n칰mero de datasets econom칠tricos.

En este caso, los datos contienen informaci칩n sobre resultados educativos,Stock & Watson (2007). Incluyen caracter칤sticas sociodemogr치ficas de estudiantes y escuelas en distritos de California.

```{r, message=FALSE, warning=FALSE}
#data(package='AER') # Lista los datasets disponibles en el paquete AER
```

Se cargan los datos:

```{r}
data("CASchools")
```

```{r, echo=FALSE}
CASchools %>% select(math, teachers, students, lunch, income, expenditure, computer) %>% 
  skimr::skim() %>% 
  select(Variable = skim_variable,
         Prom = numeric.mean, 
         SD = numeric.sd, 
         Min = numeric.p0,
         p25 = numeric.p25,
         Mediana = numeric.p50,
         Max = numeric.p100,
         Distribuci칩n = numeric.hist, 
         `N faltantes`=n_missing) %>% 
  gt() %>% fmt_number(2:7, decimals = 2) %>% 
  tab_header(title=md('**Tama침o de clase y desempe침o en matem치tica**'),
             subtitle='Distribuci칩n de las variables relevantes') 
```

# Algunos conceptos vinculados a regresiones

# 1. Regresi칩n lineal

$\hat{Y} = \alpha + \beta * X_1$

Se busca estimar el efecto de lunch sobre math:

```{r}
modelo_reg_lineal <- lm(math ~ lunch, data=CASchools)
```

Con {equatiomatic} se visualiza la ecuaci칩n del modelo:

```{r, eval=FALSE}
equatiomatic::extract_eq(modelo_reg_lineal)
```

```{r reg_lineal_eq, echo=FALSE}
equatiomatic::extract_eq(modelo_reg_lineal, 
                         vars_colors      = c(tama침o = 'red'),
                         greek_colors     = c('black', 'red', 'black'), 
                         subscript_colors = c('black', 'red', 'black')) 

  # tex_preview(usrPackages = usrPackages)
```

Tambi칠n es posible visualizar la regresi칩n lineal estimada (con los coeficientes correspondientes):

```{r reg_lineal_eq_coef}
equatiomatic::extract_eq(modelo_reg_lineal, use_coefs=TRUE) 
```

El error de estimaci칩n es la diferencia entre el valor observado y el valor predicho:

$$ \operatorname{math} - \operatorname{\widehat{math}} = \epsilon $$

Visualmente: 

```{r plot_reg_fit, fig.height=3, fig.width=5, echo=FALSE, message=FALSE}
m_eq <- equatiomatic::extract_eq(modelo_reg_lineal, 
                                 use_coef = TRUE, ital_vars = TRUE)
prep_eq <- gsub("\\\\_", "-", m_eq)
prep_eq <- paste("$", as.character(prep_eq), "$", sep = "")

CASchools %>% 
  ggplot(aes(x=lunch, y=math))+
  geom_point(color='red', alpha=0.2, size=1)+
  xlim(c(0,max(CASchools$lunch)))+
  stat_smooth(method='lm', color='blue', se=FALSE, fullrange=TRUE)+
  labs(
    title = "Relaci칩n entre ayuda para almuerzo y el desempe침o en matem치tica",
    subtitle = latex2exp::TeX(prep_eq)
  )+
  theme_minimal()
```


```{r plot_reg_pred, fig.height=3, fig.width=5, echo=FALSE, message=FALSE}
preds <- data.frame(lunch = c(5,20,50)) %>% 
  mutate(math_pred = predict(modelo_reg_lineal, .), 
         caso = c('red','green', 'black'), 
         texto= paste0('(Lunch=',lunch,', Math=',round(math_pred),')')) 

ggplot(data=CASchools)+
  
  xlim(c(0,max(CASchools$lunch)))+
  ylim(c(min(CASchools$math),max(CASchools$math)))+
  stat_smooth(aes(x=lunch, y=math), 
              method='lm', color='blue', se=FALSE, fullrange=TRUE)+
  
  geom_point(data=preds, show.legend = FALSE,
             aes(x=lunch, y=math_pred, color=caso), size=4)+
  
  geom_segment(data=preds, linetype=2, show.legend = FALSE,
               aes(x=0, xend=lunch,  
                   y=math_pred, yend=math_pred, 
                   color=caso)) +
  geom_segment(data=preds, linetype=2, show.legend = FALSE,
               aes(x=lunch, xend=lunch,  
                   y=min(CASchools$math), yend=math_pred, 
                   color=caso)) +
  
  geom_text(data=preds, vjust=-0.5, hjust=-0.1,
            aes(x=lunch, y=math_pred, label=texto, color=caso))+
  
  scale_color_identity()+
  
  
  labs(
    title = "Relaci칩n entre el tama침o de la clase y el desempe침o en matem치tica",
    subtitle = latex2exp::TeX(prep_eq))+
  theme_minimal()+theme(legend.position = 'none')
```

## 1.1: Supuestos para regresi칩n lineal

```{r, fig.height=10}
performance::check_model(modelo_reg_lineal)
```

------------------------------------------------------------------------



# 2. Regresi칩n lineal multivariada

# 3. GLM: Generalized linear models

Para casos en los cuales no se cumple el supuesto de normalidad de la variable Y (outcome).

## 3.1: Regresi칩n log칤stica (outcome binario)

Y \~ Binomial()

## 3.2: Regresi칩n de Poisson (conteo)

Y \~ Poisson()
